# MEDS-pipeline
MEDS pipeline for both MIMIC and AHS datasets

**Note**: This pipeline only supports MEDS-CORE format. MEDS-PLUS has been removed.

## Quick Start Examples

```bash
# Test with MIMIC dataset (100 patients)
python3 -m meds_pipeline.cli run --source mimic --components admissions,eds,diagnosis,procedures --cfg mimic.yaml --max-patients 100

# AHS medicines component (100 patients)
python3 -m meds_pipeline.cli run --source ahs --components admissions,eds,diagnosis,procedures --cfg ahs.yaml --max-patients 100

# MIMIC with multiple components (100 patients, CORE format - default)
PYTHONPATH=src python3 -m meds_pipeline.cli run --source mimic --components admissions,eds --cfg src/meds_pipeline/configs/mimic.yaml --max-patients 100 --progress

# AHS with multiple components (100 patients, CORE format - default)
PYTHONPATH=src python3 -m meds_pipeline.cli run --source ahs --components admissions,eds --cfg src/meds_pipeline/configs/ahs.yaml --max-patients 100 --progress
```

## Progress Display and Patient Limiting Features

### New Features Overview

This MEDS pipeline includes two important features:

#### 1. Detailed Progress Display
- ğŸ“– Data loading phase: Shows file reading progress and row counts
- ğŸ“Š Component processing: Shows rows and patient counts generated by each component
- ğŸ”— Data merging: Shows final merge results
- â±ï¸ Processing time: Shows overall processing time

#### 2. Patient Count Limiting
- ğŸ§ª Test mode: Limit processing to a specific number of patients
- ğŸš€ Quick validation: Verify pipeline functionality on small datasets
- ğŸ“Š Resource control: Avoid processing oversized datasets during testing

## Usage

### Basic Command Format
```bash
python3 -m meds_pipeline.cli run \
  --source <mimic|ahs> \
  --components <component1,component2> \
  [--max-patients N] \
  [--progress|--no-progress]
```

### Example Usage

#### 1. Test Mode (Recommended for Getting Started)
```bash
# Process only 100 patients for quick testing (CORE format is default)
python3 -m meds_pipeline.cli run \
  --source mimic \
  --components medicines \
  --max-patients 100 \
  --progress
```

#### 2. Medium-Scale Testing
```bash
# Process 1000 patients
python3 -m meds_pipeline.cli run \
  --source mimic \
  --components admissions,medicines \
  --max-patients 1000
```

#### 3. Full Run (Production Mode)
```bash
# Process all patients
python3 -m meds_pipeline.cli run \
  --source mimic \
  --components admissions,medicines \
  --progress
```

#### 4. Silent Mode (No Progress Display)
```bash
# No detailed progress information
python3 -m meds_pipeline.cli run \
  --source mimic \
  --components medicines \
  --max-patients 500 \
  --no-progress
```

## New Output Example

With progress display enabled, you'll see output like this:

```
ğŸš€ Processing 1 components...
ğŸ“Š Patient limit: 100
============================================================

ğŸ“‹ Component 1/1: medicines
ğŸ“– Loading medication data...
   â””â”€ Loaded 1,234,567 rows
   â””â”€ Limited to 100/45,678 patients, 2,345 rows
   âœ… Generated 2,345 rows for 100 patients

ğŸ”— Combining all components...
   âœ… Final result: 2,345 rows for 100 patients

Data processing completed in 15.23 seconds
Generated 2,345 rows for 100 unique patients
```

Note on output chunking: when the pipeline's output contains more than the default chunk size (100,000 rows), results are split into multiple files named `<source>_meds_core_part_{NNN}.parquet` and saved under `base.output_dir/<source>/`; otherwise a single file `<source>_meds_core.parquet` is written.

## Parameter Reference

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `--max-patients` | int | None | Limit the number of patients to process for testing |
| `--progress` | flag | True | Show detailed progress information |
| `--no-progress` | flag | False | Hide progress information |
| `--source` | choice | Required | Data source: mimic or ahs |
| `--components` | string | Required | Comma-separated list of components |

## Recommended Workflow

### First Time Usage
1. **Small-scale test**: Use `--max-patients 10` for quick verification
2. **Medium test**: Use `--max-patients 100` to check result quality
3. **Large-scale test**: Use `--max-patients 1000` to verify performance
4. **Production run**: Remove `--max-patients` to process all data

### Debugging Issues
1. Use `--max-patients 10 --progress` for the most detailed debugging information
2. Check if output row counts and patient counts meet expectations
3. If issues arise, start with small datasets and gradually increase scale

## Performance Optimization

- Patient limiting takes effect during the data loading phase, avoiding unnecessary data processing
- Progress display helps you understand which steps are most time-consuming
- You can optimize data processing workflows based on progress information

## Troubleshooting

### Common Issues
1. **Out of memory**: Use smaller `--max-patients` values
2. **Processing too slow**: Check progress output to find bottleneck steps
3. **Patient count doesn't match expectations**: Check the `subject_id` column in source data

### Debugging Steps
1. Start testing with `--max-patients 10`
2. Check output statistics for each component
3. Gradually increase patient count until you find the appropriate scale

TODO:

write build_schema
write write_df
Write Test

## Project Structure

```
MEDS-pipeline/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ args.py
â”‚   â””â”€â”€ meds_pipeline/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ cli.py
â”‚       â”œâ”€â”€ configs/
â”‚       â”‚   â”œâ”€â”€ ahs.yaml
â”‚       â”‚   â”œâ”€â”€ base.yaml
â”‚       â”‚   â””â”€â”€ mimic.yaml
â”‚       â””â”€â”€ etl/
â”‚           â”œâ”€â”€ base.py
â”‚           â”œâ”€â”€ registry.py
â”‚           â”œâ”€â”€ ahs/
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â””â”€â”€ admissions.py
â”‚           â”‚   â””â”€â”€ ...
â”‚           â””â”€â”€ mimic/
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â””â”€â”€ admissions.py
â”‚           â”‚   â””â”€â”€ ...
â”‚           â””â”€â”€ orchestrators/
â”‚           â”‚   â”œâ”€â”€ __init__.py
â”‚           â”‚   â””â”€â”€ ahs_source.py
â”‚           â”‚   â””â”€â”€ mimic_source.py
â””â”€â”€ tests/
```

## Planned

For MIMIC, Get Code.parquet, which has all dx, procedure, medicine's description
Just check if we could find all exist code from Code.parquet

For AHS, we should have ICD-10 CA Description, and CCI code csv file. 